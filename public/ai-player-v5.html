<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Player V5 - Poietic Generator (O-N-W Architecture)</title>
    <link rel="stylesheet" href="css/llm-player.css">
    <style>
        /* Header Banner Styles */
        .header-banner {
            background: #1a1a1a;
            border-bottom: 2px solid #333;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .banner-title {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            text-align: left;
        }
        
        .banner-info {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: #aaa;
            flex-wrap: wrap;
        }
        
        .banner-info span {
            white-space: nowrap;
        }
        
        .banner-info span span {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .banner-buttons {
            display: flex;
            gap: 6px;
            justify-content: flex-start;
        }
        
        .banner-buttons button {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }
        
        .banner-buttons #btn-start {
            background: #4CAF50;
            color: white;
        }
        
        .banner-buttons #btn-start:hover {
            background: #45a049;
        }
        
        .banner-buttons #btn-pause {
            background: #FF9800;
            color: white;
        }
        
        .banner-buttons #btn-pause:hover:not(:disabled) {
            background: #e68900;
        }
        
        .banner-buttons #btn-locate {
            background: #2196F3;
            color: white;
        }
        
        .banner-buttons #btn-locate:hover:not(:disabled) {
            background: #0b7dda;
        }
        
        .banner-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tabs Styles */
        .tabs-container {
            display: flex;
            flex-direction: column;
            height: calc(100% - 100px);
        }
        
        .tabs-nav {
            display: flex;
            background: #0d0d0d;
            border-bottom: 1px solid #333;
            padding: 0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: #0d0d0d;
            border: none;
            border-right: 1px solid #333;
            color: #888;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s, color 0.2s;
        }
        
        .tab-btn:last-child {
            border-right: none;
        }
        
        .tab-btn:hover {
            background: #1a1a1a;
            color: #aaa;
        }
        
        .tab-btn.active {
            background: #2a2a2a;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        
        .tabs-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Adjust control panel */
        .control-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .control-panel .header {
            display: none; /* Hidden, replaced by header-banner */
        }
        
        /* Verbatim and Filtered Responses Styles */
        .response-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #333;
        }
        
        .response-timestamp {
            font-size: 11px;
            color: #888;
        }
        
        .response-iteration {
            font-size: 11px;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .response-content {
            font-size: 12px;
            color: #ccc;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .filtered-response-section {
            margin-bottom: 12px;
        }
        
        .filtered-response-label {
            font-size: 10px;
            color: #888;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .filtered-response-text {
            font-size: 12px;
            color: #ccc;
        }
        
        .responses-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Verbatim tab: full height with scroll */
        #tab-verbatim .responses-container {
            max-height: calc(100vh - 280px);
            height: calc(100vh - 280px);
            overflow-y: auto;
        }
        
        /* Images Display */
        .images-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .image-item {
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            background: #1a1a1a;
        }
        
        .image-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .image-thumbnail {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
            display: block;
        }
        
        .image-thumbnail:hover {
            opacity: 0.8;
        }
        
        .image-placeholder {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px;
            background: #0d0d0d;
            border-radius: 4px;
        }

        /* Modal pour afficher les images en grand */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            cursor: pointer;
        }

        .image-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
        }

        .image-modal-close:hover {
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Viewer Panel -->
        <div class="viewer-panel">
            <iframe id="viewer-frame" src="/viewer2"></iframe>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <!-- Header Banner -->
            <div class="header-banner">
                <div class="banner-title">AI Player V5 - Poietic Generator</div>
                <div class="banner-info">
                    <span>Mode: <span id="v4-mode">seed</span></span>
                    <span>LLM Model: <span id="header-llm-model">Gemini Flash 2.5</span></span>
                    <span>Agent position: <span id="header-position">[-, -]</span></span>
                </div>
                <div class="banner-buttons">
                    <button id="btn-start">‚ñ∂ Start</button>
                    <button id="btn-pause" disabled>‚è∏ Pause</button>
                    <button id="btn-locate" disabled>üìç Locate</button>
                </div>
            </div>

            <!-- Tabs Container -->
            <div class="tabs-container">
                <!-- Tabs Navigation -->
                <div class="tabs-nav">
                    <button class="tab-btn active" data-tab="config">‚öôÔ∏è Config</button>
                    <button class="tab-btn" data-tab="monitoring">üìä Metrics</button>
                    <button class="tab-btn" data-tab="verbatim">üí¨ Verbatim</button>
                    <button class="tab-btn" data-tab="debug">üì∏ Debug</button>
                </div>

                <!-- Tabs Content -->
                <div class="tabs-content">
                    <!-- Tab 1: Config -->
                    <div class="tab-panel active" id="tab-config">
                        <div class="input-group">
                            <label>LLM Model</label>
                            <select id="llm-model-select">
                                <option value="gemini-v4" selected>üíé Google Gemini V4 (O/W Alternation)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>API Key</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="password" id="api-key" placeholder="Gemini API key..." style="flex: 1;">
                                <button id="btn-clear-key" style="flex: none; width: auto; padding: 10px 12px; background: #555; font-size: 12px;" title="Clear key">üóëÔ∏è</button>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>Viewer URL <span class="viewer-url-toggle" id="toggle-viewer-url">‚ñº Change</span></label>
                            <select id="viewer-url" style="display: none;">
                                <option value="/viewer">Viewer (humans - no buffer)</option>
                                <option value="/viewer2" selected>Viewer2 (LLM - black bg + buffer)</option>
                                <option value="/viewer3">Viewer3 (LLM DEBUG - ColorGen + buffer)</option>
                                <option value="http://localhost:3001/viewer">Local viewer (localhost:3001)</option>
                                <option value="http://localhost:3001/viewer2">Local viewer2 (localhost:3001)</option>
                                <option value="http://localhost:3001/viewer3">Local viewer3 (localhost:3001)</option>
                                <option value="https://poietic-generator.net/viewer">Production (poietic-generator.net)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>Delay after iteration (s)</label>
                            <input type="number" id="interval" value="20" min="0" max="60">
                        </div>

                        <!-- Status Section -->
                        <div class="section">
                            <div class="section-title">Status</div>
                            <div class="decision-box" style="margin-top:12px;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                    <span class="status-badge disconnected" id="status-badge">Disconnected</span>
                                    <span class="status-badge disconnected" id="llm-status-badge">LLM: Inactive</span>
                                    <span style="margin-left:auto; font-size:11px; color:#888;" id="user-id-display">‚Äî</span>
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:12px; color:#ccc;">
                                    <div>Tokens IN (last): <b id="tokens-in-last">0</b></div>
                                    <div>Tokens OUT (last): <b id="tokens-out-last">0</b></div>
                                    <div>Tokens IN (total): <b id="tokens-in-total">0</b></div>
                                    <div>Tokens OUT (total): <b id="tokens-out-total">0</b></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Monitoring / Metrics -->
                    <div class="tab-panel" id="tab-monitoring">
                        <!-- Simplicity Theory Metrics - V5: O-machine + Prediction Errors -->
                        <div class="section">
                            <div class="section-title">SIMPLICITY METRICS</div>
                            <div id="simplicity-metrics-container" style="background: #1a1a1a; padding: 10px; border-radius: 6px; font-family: monospace;">
                                
                                <!-- O+N-machine Graph (Server-side) -->
                                <div style="margin-bottom: 15px;">
                                    <div style="color: #888; font-size: 12px; margin-bottom: 5px;">
                                        Iteration: <span id="o-version">0</span> | 
                                        C_w: <span id="o-cw">0</span> | 
                                        C_d: <span id="o-cd">0</span> | 
                                        U: <span id="o-u">0</span>
                                    </div>
                                    <canvas id="simplicity-chart-o" width="400" height="120" style="width: 100%; height: 120px;"></canvas>
                                    <div style="color: #ccc; font-size: 12px; margin-top: 5px;">
                                        <span style="color: #4A90E2;">‚ñ†</span> C_w
                                        <span style="color: #E24A4A;">‚ñ†</span> C_d
                                        <span style="color: #4AE290;">‚ñ†</span> U
                                    </div>
                                </div>

                                <!-- V5: Graphique erreurs de pr√©diction (remplace graphique W-machine) -->
                                <div style="margin-top: 20px; margin-bottom: 15px;">
                                    <h4 style="color: #888; margin: 0 0 8px 0; font-size: 16px; font-weight: bold; text-transform: uppercase;">PREDICTION ERRORS</h4>
                                    <div style="color: #888; font-size: 12px; margin-bottom: 5px;">
                                        Current Error: <span id="prediction-error">0.00</span> | 
                                        Mean Error: <span id="mean-error-display">0.00</span> | 
                                        Rank: <span id="rank-display">-</span> / <span id="total-agents">-</span>
                                    </div>
                                    <canvas id="predictionErrorChart" width="800" height="120" style="width: 100%; height: 120px;"></canvas>
                                    <div style="color: #ccc; font-size: 12px; margin-top: 5px;">
                                        <span style="color: #007bff; font-weight: bold;">‚óè</span> Agent Error
                                        <span style="margin-left: 12px; color: #28a745; font-weight: bold;">‚óè</span> Mean Agents Error
                                        <span style="margin-left: 12px; color: #dc3545; font-weight: bold;">‚ãØ</span> Std Deviation
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Tab 3: Verbatim -->
                    <div class="tab-panel" id="tab-verbatim">
                        <div class="section">
                            <div class="section-title">VERBATIM</div>
                            <div class="responses-container" id="verbatim-responses">
                                <div class="image-placeholder">No responses yet</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 4: Debug -->
                    <div class="tab-panel" id="tab-debug">
                        <!-- Event Log -->
                        <div class="section">
                            <div class="section-title">Event Log</div>
                            <div class="journal" id="journal">
                                <div class="journal-entry">Waiting for connection...</div>
                            </div>
                        </div>

                        <!-- Images sent to LLM -->
                        <div class="section">
                            <div class="section-title">Images sent to LLM</div>
                            <div class="images-display" id="llm-images">
                                <div class="image-placeholder">No images sent yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour afficher les images en grand -->
    <div id="image-modal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <div class="image-modal-content">
            <img id="modal-image" src="" alt="LLM Image">
        </div>
    </div>

    <!-- Scripts V4 - O/W Alternation -->
    <script type="module" src="js/spatial-analysis.js?v=20250116-52"></script>
    <script type="module" src="js/llava-canvas.js?v=20250124-053"></script>
    <!-- Load Gemini V5 and expose globally -->
    <script type="module">
        import { GeminiV5Adapter } from './js/llm-adapters/gemini-v5.js?v=20250124-v5-6';
        window.GeminiV5Adapter = GeminiV5Adapter;
        console.log('‚úÖ [V5] Gemini V5 Adapter (O-N-W Architecture) exposed globally');
    </script>
    <script type="module" src="js/ai-player-v5.js?v=20250124-v5-6"></script>
</body>
</html>
